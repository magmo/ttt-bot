import pytest
import web3

from bot.config import ADDRESSES
import bot.wallet
from util import get_wallets_fn

#pylint: disable=C0301
MESSSAGE = '000000000000000000000000c1912fee45d61c87cc5ea59dae31190fffff232d00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000000020000000000000000000000005291fA3F70C8e3D21B58c831018E5a0D82Dc4ab90000000000000000000000009552ceb4e6fa8c356c1a76a8bc8b1efa7b9fb205000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000006a94d74f4300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc10000'
MESSSAGE2 = '000000000000000000000000c1912fee45d61c87cc5ea59dae31190fffff232d00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000000020000000000000000000000005291fA3F70C8e3D21B58c831018E5a0D82Dc4ab90000000000000000000000009552ceb4e6fa8c356c1a76a8bc8b1efa7b9fb205000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000006a94d74f4300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc10001'
REVEAL_MESSAGE = '000000000000000000000000c1912fee45d61c87cc5ea59dae31190fffff232d00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000000020000000000000000000000005291fA3F70C8e3D21B58c831018E5a0D82Dc4ab90000000000000000000000009552ceb4e6fa8c356c1a76a8bc8b1efa7b9fb205000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000058d15e17628000000000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000lt'


def test_sign_message():
    signature = bot.wallet.sign_message(MESSSAGE, ADDRESSES[0])
    assert signature == '872695a7dd2591e95231bb91e7068baf927059e3d725cd8ddf547862498cbbff4703d2dca0878ceb3e86b06675b5c3f948ef83f4f0a9cd675c030fc36ea8f2861b'


@pytest.mark.usefixtures("test_app")
def test_fund_adjudicator(mocker):
    #pylint: disable=C0301
    tx_hash = '0x51d8596e4f8a0b6d583a8e182ee3a6b397814b7812af448ab56f07e61d793ba9'
    mocker.patch('firebase_admin.db.Query.get', new=get_wallets_fn('wallets'))
    mocker.patch('firebase_admin.db.Reference.transaction', lambda _1, _2: 10)
    mocker.patch('web3.eth.Eth.gasPrice', 2000000000)
    mocker.patch('web3.eth.Eth.sendRawTransaction', autospec=True)
    response = bot.wallet.fund_adjudicator(
        'cdb594a32b1cc3479d8746279712c39d18a07fc0', ADDRESSES[0])

    web3.eth.Eth.sendRawTransaction.assert_called_once()  # pylint: disable=no-member
    assert response['message'] == f'Funding success with transaction hash of {tx_hash}'


def test_clear_wallet_channel(test_app):  # pylint: disable=W0613
    # This test uses the test Firebase realtime database
    bot.wallet.clear_wallet_channel(REVEAL_MESSAGE, ADDRESSES[0])

    last_move = bot.wallet.get_last_opponent_move(REVEAL_MESSAGE, ADDRESSES[0])
    assert last_move is None
    last_message = bot.wallet.get_last_message_for_channel(
        REVEAL_MESSAGE, ADDRESSES[0])
    assert last_message is None
