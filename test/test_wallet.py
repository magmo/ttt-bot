import pytest
import web3

from bot.config import ADDRESSES
import bot.wallet
from util import get_wallets_fn

#pylint: disable=C0301
MESSSAGE = '000000000000000000000000c1912fee45d61c87cc5ea59dae31190fffff232d00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000000020000000000000000000000005291fA3F70C8e3D21B58c831018E5a0D82Dc4ab900000000000000000000000055de2e479F3D0183D95f5A969bEEB3a147F60049000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000006a94d74f4300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc10000'
MESSSAGE2 = '000000000000000000000000c1912fee45d61c87cc5ea59dae31190fffff232d00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000000020000000000000000000000005291fA3F70C8e3D21B58c831018E5a0D82Dc4ab900000000000000000000000055de2e479F3D0183D95f5A969bEEB3a147F60049000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000006a94d74f430000000000000000000000000000000000000000000000000000006a94d74f4300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc10001'
REVEAL_MESSAGE = '000000000000000000000000c1912fee45d61c87cc5ea59dae31190fffff232d00000000000000000000000000000000000000000000000000000000000001c800000000000000000000000000000000000000000000000000000000000000020000000000000000000000005291fA3F70C8e3D21B58c831018E5a0D82Dc4ab900000000000000000000000055de2e479F3D0183D95f5A969bEEB3a147F60049000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000058d15e17628000000000000000000000000000000000000000000000000000002c68af0bb1400000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000lt'

def test_sign_message():
    signature = bot.wallet.sign_message(MESSSAGE, ADDRESSES[0])
    assert signature == '708b8791d6054bda70f260a1f47a71ea47942f96bee5a2dfe232fa1d2c4ce3fc3806c6a87d8ecb889d019169b2710d3e833dabba8d6aa872fc49de420bb3a27d1c'

@pytest.mark.usefixtures("test_app")
def test_fund_adjudicator(mocker):
    #pylint: disable=C0301
    tx_hash = '0xf83e9fe1ff88ea1c9428681da936e92bf501866985608eb24e320a4bd1ec57f6'
    mocker.patch('firebase_admin.db.Query.get', new=get_wallets_fn('wallets'))
    mocker.patch('firebase_admin.db.Reference.transaction', lambda _1, _2: 10)
    mocker.patch('web3.eth.Eth.gasPrice', 2000000000)
    mocker.patch('web3.eth.Eth.sendRawTransaction', autospec=True)
    response = bot.wallet.fund_adjudicator('cdb594a32b1cc3479d8746279712c39d18a07fc0', ADDRESSES[0])

    web3.eth.Eth.sendRawTransaction.assert_called_once() # pylint: disable=no-member
    assert response['message'] == f'Funding success with transaction hash of {tx_hash}'

def test_set_last_message_for_channel(test_app): #pylint: disable=W0613
    # This test uses the test Firebase realtime database
    bot.wallet.clear_wallet_channels(ADDRESSES[0])
    bot.wallet.set_last_message_for_channel(MESSSAGE, ADDRESSES[0])
    last_message = bot.wallet.get_last_message_for_channel(MESSSAGE, ADDRESSES[0])
    assert last_message == MESSSAGE

    bot.wallet.set_last_message_for_channel(MESSSAGE2, ADDRESSES[0])
    last_message = bot.wallet.get_last_message_for_channel(MESSSAGE, ADDRESSES[0])
    assert last_message != MESSSAGE

def test_set_last_opponent_move(test_app): #pylint: disable=W0613
    # This test uses the test Firebase realtime database
    bot.wallet.clear_wallet_channels(ADDRESSES[0])
    bot.wallet.set_last_opponent_move(REVEAL_MESSAGE, ADDRESSES[0])
    last_move = bot.wallet.get_last_opponent_move(REVEAL_MESSAGE, ADDRESSES[0])
    assert last_move == 1

def test_clear_wallet_channel(test_app): #pylint: disable=W0613
    # This test uses the test Firebase realtime database
    bot.wallet.set_last_opponent_move(REVEAL_MESSAGE, ADDRESSES[0])
    bot.wallet.clear_wallet_channel(REVEAL_MESSAGE, ADDRESSES[0])

    last_move = bot.wallet.get_last_opponent_move(REVEAL_MESSAGE, ADDRESSES[0])
    assert last_move is None
    last_message = bot.wallet.get_last_message_for_channel(REVEAL_MESSAGE, ADDRESSES[0])
    assert last_message is None
